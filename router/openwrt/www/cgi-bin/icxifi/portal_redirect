#!/bin/sh
# Entry point:
# - active      -> portal
# - inactive    -> notice page (inactive)
# - no_license  -> notice page (no license)
# - unknown     -> registration page
# Add ?setup=1 to force binding page (for re-activation).
# Preserve QUERY_STRING so OpenNDS fas param (clientip, clientmac) reaches portal.
set -eu
GW="$(cat /etc/icxifi/gateway_ip 2>/dev/null | tr -d '\r\n' | cut -d/ -f1)"
GW="${GW:-10.0.0.1}"
CLOUD_STATE="unknown"

probe_cloud_state() {
  BASE="$(tr -d '\r\n' < /etc/icxifi/cloud_base_url 2>/dev/null || true)"
  RID="$(tr -d '\r\n' < /etc/icxifi/router_id 2>/dev/null || true)"
  APIKEY="$(tr -d '\r\n' < /etc/icxifi/router_api_key 2>/dev/null || true)"

  if [ -z "$RID" ]; then
    RID="$(ip -o link show br-lan 2>/dev/null | awk '/link\/ether/ {print tolower($17); exit}')"
  fi
  if [ -z "$RID" ]; then
    RID="$(ip -o link show eth0 2>/dev/null | awk '/link\/ether/ {print tolower($17); exit}')"
  fi

  [ -n "$BASE" ] || { CLOUD_STATE="not_registered"; return 1; }
  [ -n "$RID" ] || { CLOUD_STATE="not_registered"; return 1; }
  [ -n "$APIKEY" ] || { CLOUD_STATE="not_registered"; return 1; }

  BASE="${BASE%/}"
  case "$BASE" in
    */api) BASE="${BASE%/api}" ;;
  esac
  RESP="$(curl -sS -m 6 -X GET "$BASE/api/router/state" \
    -H "Authorization: Bearer $APIKEY" \
    -H "X-Router-ID: $RID" \
    -H "ngrok-skip-browser-warning: true" \
    -w '\n%{http_code}' 2>/dev/null)" || { CLOUD_STATE="cloud_unreachable"; return 1; }

  HTTP_CODE="$(printf '%s' "$RESP" | tail -n1)"
  BODY="$(printf '%s' "$RESP" | sed '$d')"

  if [ "$HTTP_CODE" = "200" ] && printf '%s' "$BODY" | grep -q '"ok"[[:space:]]*:[[:space:]]*true'; then
    STATE="$(printf '%s' "$BODY" | sed -n 's/.*"state"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/p' 2>/dev/null | head -1)"
    case "$STATE" in
      active|inactive|no_license)
        CLOUD_STATE="$STATE"
        ;;
      *)
        CLOUD_STATE="unknown"
        ;;
    esac
    return 0
  fi

  # If cloud says credentials are invalid, clear stale local registration markers.
  if [ "$HTTP_CODE" = "401" ] || [ "$HTTP_CODE" = "403" ] || [ "$HTTP_CODE" = "404" ]; then
    rm -f /etc/icxifi/router_api_key /etc/icxifi/license_key 2>/dev/null || true
    CLOUD_STATE="not_registered"
    return 1
  fi

  CLOUD_STATE="cloud_unreachable"
  return 1
}

FORCE_SETUP=""
case "$QUERY_STRING" in
  *setup=1*|*setup=true*) FORCE_SETUP=1 ;;
esac
QS="${QUERY_STRING:+?$QUERY_STRING}"
if [ -n "$FORCE_SETUP" ]; then
  REDIRECT="http://${GW}:2080/register.html${QS}"
elif probe_cloud_state; then
  case "$CLOUD_STATE" in
    active)
      REDIRECT="http://${GW}:2080/portal.html${QS}"
      ;;
    inactive|no_license)
      RS="state=${CLOUD_STATE}"
      case "$QS" in
        "") REDIRECT="http://${GW}:2080/notice.html?${RS}" ;;
        \?*) REDIRECT="http://${GW}:2080/notice.html?${RS}&${QS#\?}" ;;
        *) REDIRECT="http://${GW}:2080/notice.html?${RS}" ;;
      esac
      ;;
    *)
      REDIRECT="http://${GW}:2080/register.html${QS}"
      ;;
  esac
else
  REDIRECT="http://${GW}:2080/register.html${QS}"
fi
printf 'Status: 302 Found\r\nLocation: %s\r\nContent-Type: text/html\r\n\r\n' "$REDIRECT"
printf '<!DOCTYPE html><html><head><meta http-equiv="refresh" content="0;url=%s"></head><body>Redirecting...</body></html>' "$REDIRECT"
